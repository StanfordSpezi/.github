#
# This source file is part of the Stanford Spezi open-source project
#
# SPDX-FileCopyrightText: 2022 Stanford University and the project authors (see CONTRIBUTORS.md)
#
# SPDX-License-Identifier: MIT
#

name: Test using xcodebuild or run fastlane

on:
  workflow_call:
    inputs:
      path:
        description: 'The path where the project is located. Defaults to $GITHUB_WORKSPACE'
        required: false
        type: string
        default: '.'
      runsonlabels:
        description: 'JSON-based collection of labels indicating which type of github runner should be chosen'
        required: false
        type: string
        default: '["macos-latest"]'
      xcodeversion:
        description: 'The Xcode version used for the build'
        required: false
        type: string
        default: 'latest-stable'
      scheme:
        description: 'The scheme in the Xcode project. Either use `scheme` to use xcodebuild, `fastlanelane` to use fastlane, or a custom command using `customcommand`'
        required: false
        type: string
        default: ''
      test:
        description: 'A flag indicating if the tests of the Xcode project scheme should run'
        required: false
        type: boolean
        default: true
      fastlanelane:
        description: 'The lane of the fastlane command. Either use `scheme` to use xcodebuild, `fastlanelane` to use fastlane, or a custom command using `customcommand`'
        required: false
        type: string
        default: ''
      customcommand:
        description: 'A custom command that should be run after the setup. Either use `scheme` to use xcodebuild, `fastlanelane` to use fastlane, or a custom command using `customcommand`'
        required: false
        type: string
        default: ''
      artifactname:
        description: 'The name & path of the artifact that should be uploaded at the end of the build.'
        required: false
        type: string
        default: ''
      setupsigning:
        description: 'Setup the keychain to include Apple certificate and provisioning profile'
        required: false
        type: boolean
        default: false
      cacheDerivedData:
        description: 'Cache the derived data folder for a build using xcodebuild'
        required: false
        type: boolean
        default: false
      setupfirebaseemulator:
        description: 'Setup the Firebase Emulator'
        required: false
        type: boolean
        default: false
      codeql:
        description: 'Use CodeQL code scanning'
        required: false
        type: boolean
        default: false
    secrets:
      BUILD_CERTIFICATE_BASE64:
        description: 'The Base64 version of the Apple signing certificate to build your iOS application.'
        required: false
      P12_PASSWORD:
        description: 'The password for the Apple signing certificate.'
        required: false
      BUILD_PROVISION_PROFILE_BASE64:
        description: 'The Base64 version of the Apple provisioning profile to build your iOS application.'
        required: false
      KEYCHAIN_PASSWORD:
        description: 'A password for the keychain that will be created on the runner instance.'
        required: false
      APP_STORE_CONNECT_API_KEY_ID:
        description: 'The key ID of the API key created in the App Store Connect API keys section.'
        required: false
      APP_STORE_CONNECT_ISSUER_ID:
        description: 'The issuer ID of the App Store Connect API is displayed in the App Store Connect API keys section.'
        required: false
      APP_STORE_CONNECT_API_KEY_BASE64:
        description: 'The content of the key created in App Store Connect condensed into a Base64 representation, e.g., using base64 -i AuthKey_ABCDEFGHIJ.p8 | pbcopy.'
        required: false
      APPLE_ID:
        description: 'The Apple ID you use to access the App Store Connect API.'
        required: false

jobs:
  build_and_test:
    name: Test using xcodebuild or run fastlane
    uses: StanfordBDHG/.github/.github/workflows/xcodebuild-or-fastlane.yml@v2
    secrets:
      BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
      P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
      BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
      KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
    with:
      path: ${{ inputs.path }}
      runsonlabels: ${{ inputs.runsonlabels }}
      xcodeversion: ${{ inputs.xcodeversion }}
      scheme: ${{ inputs.scheme }}
      test: ${{ inputs.test }}
      fastlanelane: ${{ inputs.fastlanelane }}
      customcommand: ${{ inputs.customcommand }}
      artifactname: ${{ inputs.artifactname }}
      setupsigning: ${{ inputs.setupsigning }}
      cacheDerivedData: ${{ inputs.cacheDerivedData }}
      setupfirebaseemulator: ${{ inputs.setupfirebaseemulator }}
      codeql: ${{ inputs.codeql }}
